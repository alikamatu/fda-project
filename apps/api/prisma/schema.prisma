generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  // Connection URLs are configured in prisma.config.ts for Prisma v7+
}

//////////////////////
// ENUMS
//////////////////////

enum UserRole {
  CONSUMER
  MANUFACTURER
  ADMIN
}

enum ProductCategory {
  DRUG
  FOOD
  COSMETIC
  MEDICAL_DEVICE
  ELECTRONIC
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VerificationStatus {
  VALID
  EXPIRED
  FAKE
  USED
}

enum AlertType {
  FAKE_PRODUCT
  EXPIRED_PRODUCT
  MULTIPLE_SCANS
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

//////////////////////
// MODELS
//////////////////////

model User {
  id            String   @id @default(uuid())
  fullName      String
  email         String   @unique
  phone         String?
  passwordHash  String
  role          UserRole
  isActive      Boolean  @default(true)

  manufacturer  Manufacturer?
  verifications VerificationLog[]
  notifications Notification[]
  auditLogs     AuditLog[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Manufacturer {
  id                 String   @id @default(uuid())
  companyName        String
  registrationNumber String   @unique
  contactEmail       String
  contactPhone       String?
  address            String
  isApproved         Boolean  @default(false)

  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id])

  products           Product[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model Product {
  id             String           @id @default(uuid())
  productName    String
  productCode    String           @unique
  description    String?
  category       ProductCategory
  approvalStatus ApprovalStatus   @default(PENDING)

  manufacturerId String
  manufacturer   Manufacturer    @relation(fields: [manufacturerId], references: [id])

  batches        ProductBatch[]
  alerts         Alert[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ProductBatch {
  id              String   @id @default(uuid())
  batchNumber     String
  manufactureDate DateTime
  expiryDate      DateTime
  quantity        Int

  productId       String
  product         Product @relation(fields: [productId], references: [id])

  verificationCodes VerificationCode[]

  createdAt       DateTime @default(now())

  @@unique([productId, batchNumber])
}

model VerificationCode {
  id              String   @id @default(uuid())
  code            String   @unique
  qrImageUrl      String?
  isUsed          Boolean  @default(false)

  productBatchId  String
  productBatch    ProductBatch @relation(fields: [productBatchId], references: [id])

  logs            VerificationLog[]

  createdAt       DateTime @default(now())
  usedAt          DateTime?
}

model VerificationLog {
  id                 String              @id @default(uuid())
  status             VerificationStatus
  location           String?
  ipAddress          String?
  deviceInfo         String?

  verificationCodeId String
  verificationCode   VerificationCode    @relation(fields: [verificationCodeId], references: [id])

  userId             String?
  user               User?               @relation(fields: [userId], references: [id])

  verifiedAt         DateTime            @default(now())
}

model Alert {
  id          String        @id @default(uuid())
  type        AlertType
  message     String
  severity    AlertSeverity
  isResolved  Boolean       @default(false)

  productId   String
  product     Product      @relation(fields: [productId], references: [id])

  createdAt   DateTime     @default(now())
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String
  entityType  String
  entityId    String
  metadata    Json?

  performedBy String
  user        User     @relation(fields: [performedBy], references: [id])

  createdAt   DateTime @default(now())
}

model Notification {
  id        String              @id @default(uuid())
  title     String
  message   String
  channel   NotificationChannel
  isRead    Boolean             @default(false)

  userId    String
  user      User                @relation(fields: [userId], references: [id])

  createdAt DateTime            @default(now())
}